<!DOCTYPE html>
<html>
<head>
<title>Control Node Install - Admin Info</title> <!-- change this to your title of choice-->
<!-- Best if you leave the style section alone. -->
<style> 
header {
    background-color: lightgray;
    text-align: center;
    font-size: 20px;
    color: black;
}
iframe {
    height:500px;
    float: left;
    width: 15%;
    padding-left:2.5%;
    padding-right:2.5%;
    overflow:hidden;
}
article{
    float: right;
    width: 70%;
    padding-right:5%;
}
</style>
</head>
<header>
<h1>Admin Info: Control node Installation Steps</h1>
</header>
<iframe src="../../TMPL/linklist.html" title="Nav Links"></iframe>
<article> 
    <p>These are the necessary steps to get the ubuntu Server that will be acting as the controlling node in the microstack configuration.</p>
    <ol>
        <li>Install ubuntu server 20 LTS</li>
        <ol>
            <li>Add the microk8s install and the SSH server</li>
            <li>Install in default hard drive configuration</li>
            <li>Statically assign the address to the NIC</li>
            <ul><ol>
                <li>Add search domains</li>
                <ul>
                    <li style="font-family:'Lucida Console', monospace">domain.local</li>
                    <li style="font-family:'Lucida Console', monospace">lab.oit.edu</li>
                    <li style="list-style:none;">This sub domain may need to change if the lab environment already has a domain assined that doesn't match.</li>
                </ul>
                <li>Add host name</li>
                <ul><li style="font-family:'Lucida Console', monospace">oscontrol</li></ul>
            </ol></ul>
            <li>Add the SSH key from the oit-learning Github</li>
            <li>Create the OIT administrator account</li>
            <ol>
                <li>NAME: <a style="font-family:'Lucida Console', monospace">OIT Administrator</a></li>
                <li>USERNAME: <a style="font-family:'Lucida Console', monospace">oit</a></li>
                <li>PASSWORD: <a style="font-family:'Lucida Console', monospace">0!tgr@d21</a></li>
            </ol>
        </ol>
        <li>Extend the file system to fill the drive with the following commands:</li>
        <ul>
            <li style="font-family:'Lucida Console', monospace">sudo lvm lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv</li>
            <li style="font-family:'Lucida Console', monospace">sudo resize2fs /dev/ubuntu-vg/ubuntu-lv</li>
        </ul>
        <!--
        <li>Setup the base Authentication System</li>
        <ol>
            <li>Install and configure the LDAP server:</li>
            <ol>
                <li><a style="font-family:'Lucida Console', monospace">sudo apt-get install slapd ldap-utils</a></li>
                <li><a style="font-family:'Lucida Console', monospace">sudo dpkg-reconfigure slapd</a></li>
                <li>Select <a style="font-family:'Lucida Console', monospace">NO</a> for OMIT Database creation </li>
                <li>Enter <a style="font-family:'Lucida Console', monospace">lab.connection.ninja</a> for the domain (if the OIT domain is available for use, substitute that for the connection.ninja domain)</li>
                <li>Enter Lab.OIT for the organization</li>
                <li>Enter <a style="font-family:'Lucida Console', monospace">0!tgr@d21</a> for the ldap password</li>
                <li>Aggree to move the old configuration to prevent conflict.</li>
            </ol>
        -->
        
            <li>Create a TLS Certificate:</li>
            <ol>
                <li><a style="font-family:'Lucida Console', monospace">sudo hostnamectl set-hostname mscontrol.lab.connection.ninja</a></li>
                <li><a style="font-family:'Lucida Console', monospace">sudo snap install  --classic certbot</a></li>
                <li><a style="font-family:'Lucida Console', monospace">sudo ln -s /snap/bin/certbot /usr/bin/certbot</a></li>
                <li><a style="font-family:'Lucida Console', monospace">sudo certbot certonly --manual --preferred-challenges dns </a><a style="color:red">*</a></li> 
                <li>Follow the steps and prompts that are provided by certbot to create the CA-Signed Certificate File. Try using the utility that they link for verifying the DNS check before moving forward.</li>
                <!--
                <li>Create an <a style="font-family:'Lucida Console', monospace">ldif</a> file that matches the <a style="font-family:'Lucida Console', monospace">certs.ldif</a> found in this directory.</li>
                <li><a style="font-family:'Lucida Console', monospace">sudo setfacl -m user:openldap:r-x /etc/letsencrypt/live</a></li>
                <li><a style="font-family:'Lucida Console', monospace">sudo setfacl -m user:openldap:r-x /etc/letsencrypt/archive</a></li>
                <li>Add the following lines to <a style="font-family:'Lucida Console', monospace">/etc/apparmor.d/local/usr.sbin.slapd</a> </li>
                <ul>
                    <li style="font-family:'Lucida Console', monospace">/etc/letsencrypt/live/{{ grains.id }} r,
                    <li style="font-family:'Lucida Console', monospace">/etc/letsencrypt/archive/{{ grains.id }} r,</li>
                    <li style="font-family:'Lucida Console', monospace">/etc/letsencrypt/archive/{{ grains.id }}/** r,</li>
                </ul>
                <li><a style="font-family:'Lucida Console', monospace">sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f ./certs.ldif</a></li>
                <li style="list-style: none;">These steps were pulled from a combination of the <a href=">https://certbot.eff.org/lets-encrypt/ubuntufocal-other">Certbot steps for Ubuntu</a> and some helpful steps for LetsEncrypt and OpenLDAP found on <a href="https://blog.poggs.com/2018/08/19/openldap-with-tls-and-letsencrypt-on-ubuntu-16-04/">Peter Hicks' Blog, blog.poggs.com</a></li>
            </ol>
            <li>Create organizational units, users and setup the server for SUDO usage</li>
            <ol>
                <li>Import or create a file to match the <a style="font-family:'Lucida Console', monospace">populate.ldif</a> file in this directory</li>
                <li>Import the necessary LDAP groups and configurations</li>
                <li style=".list-style: none; font-family:'Lucida Console', monospace">sudo ldapadd -x -D cn=admin,dc=lab,dc=connection,dc=ninja -W -f ./populate.ldif</li>
                <li>Set the admin password using the <a style="font-family:'Lucida Console', monospace">ldappasswd</a> utility:</li>
                <li style="list-style: none; font-family:'Lucida Console', monospace">sudo ldappasswd -x -D cn=admin,dc=lab,dc=connection,dc=ninja -W -S uid=oit,ou=Users,dc=lab,dc=connection,dc=ninja</li>
                <li>Prepare the server with the SUDO schema</li>
                <ol>
                    <li>Copy the <a style="font-family:'Lucida Console', monospace">schema.OPENLDAP</a> file to the destination <a style="font-family:'Lucida Console', monospace">/etc/ldap/schema/sudo.schema</a></li>
                    <li><a style="font-family:'Lucida Console', monospace">sudo apt-get install schema2ldif</a></li>
                    <li><a style="font-family:'Lucida Console', monospace">sudo ldap-schema-manager -i /etc/ldap/schema/sudo.schema</a></li>
                </ol>
                <li>Import or create a file that matches the <a style="font-family:'Lucida Console', monospace">sudoers.ldif</a> file in this directory</li>
                <li>Import the Sudo-specific groups and configurations</li>
                <li style="list-style: none; font-family:'Lucida Console', monospace">sudo ldapadd -x -D cn=admin,dc=lab,dc=connection,dc=ninja -W -f ./sudoers.ldif</li>
            </ol>-->
        </ol>
        <li>After initial installation, the following commands</li>
        <ol>
            <li style="font-family:'Lucida Console', monospace;">sudo apt-get install tasksel</li>
            <li style="font-family:'Lucida Console', monospace">sudo tasksel</li>
        </ol>
        <li>Select the Ubuntu Server Minimal Desktop Install and allow it to install</li>
        <li>Restart the server</li>
        <li>Install XRDP for remote desktop services</li>
        <ol>
            <li><a style="font-family:'Lucida Console', monospace">sudo apt-get install xrdp</li>
            <li><a style="font-family:'Lucida Console', monospace">sudo vi /etc/xrdp/xrdp.ini</a></li>
            <li>Add the directories for the ssl certificate that we created</li>
            <ul>
                <li>Certificate <a style="font-family:'Lucida Console', monospace">/etc/letsencrypt/live/mscontrol.lab.connection.ninja/cert.pem</a></li>
                <li>Certificate key <a style="font-family:'Lucida Console', monospace">/etc/letsencrypt/live/mscontrol.lab.connection.ninja/privkey.pem</a></li>
                <li>Certificate Parent Chain <a style="font-family:'Lucida Console', monospace">/etc/letsencrypt/live/mscontrol.lab.connection.ninja/fullchaim.pem</a></li>
            </ul>
            <li><a style="font-family:'Lucida Console', monospace">sudo ufw allow from 192.168.50.0/24 to any port 3389</a></li>
            <li><a style="font-family:'Lucida Console', monospace">sudo vi /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla</a></li>
            <ul>
                <li style="list-style:none"><b>Add the following to the file and save it.</b></li>
                <li><a style="font-family:'Lucida Console', monospace">[Allow Colord all Users]</a></li>
                <li style="list-style:none; font-family:'Lucida Console', monospace">Identity=unix-user:*</li>
                <li style="list-style:none; font-family:'Lucida Console', monospace">Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile</li>
                <li style="list-style:none; font-family:'Lucida Console', monosapce">ResultAny=no</li>
                <li style="list-style:none; font-family:'Lucida Console', monosapce">ResultInactive=no</li>
                <li style="list-style:none; font-family:'Lucida Console', monospace">ResultActive=yes</li>
            </ul>
            <li><a style="font-family:'Lucida Console', monospace">sudo systemctl start xrdp</a></li>
        </ol>
        <li>Aftere completion run the following commands to install Openstack Microstack <a style="color:red">**</a></li>
        <ol>
            <li style="font-family:'Lucida Console', monospace">sudo su -</li>
            <li style="font-family:'Lucida Console', monospace">snap install microstack --devmode --beta</li>
        </ol>
        <li>After completion run the following commands:</li>
        <ol>
            <li style="font-family:'Lucida Console', monospace">microstack init --auto --control</li>
            <li style="font-family:'Lucida Console', monospace">exit</li>
        </ol>
        <li>Allow the Microstac Network Bridge to have network access</li>
        <ol>
            <li style="font-family:'Lucida Console', monosapce">sudo iptables -t nat -A POSTROUTING -s 10.20.20.1/24 ! -d 10.20.20.1/24 -j MASQUERADE</li>
            <li style="font-family:'Lucida Console', monospace">sudo sysctl net.ipv4.ip_forward=1</li>
        </ol>
        <li>Add the following repository to APT by creating a file with the content below called <a style="font-family:'Lucida Console', monospace">webmin-repo.list</a> in the <a style="font-family:'Lucida Console', monospace">/etc/apt/sources.list.d/</a> directory</li>
        <ul><li style="font-family:'Lucida Console', monospace">deb https://webmin.com/download/repository sarge contrib</li></ul>
        <li>After completion run the following commands:</li>
        <ol>
            <li style="font-family:'Lucida Console', monospace">sudo apt-get install apt-transport-https</li>
            <li style="font-family:'Lucida Console', monospace">sudo wget https://download.webmin.com/jcameron-key.asc</li>
            <li style="font-family:'Lucida Console', monospace">sudo apt-key add jcameron-key.asc</li>
            <li style="font-family:'Lucida Console', monospace">sudo apt-get update</li>
            <li style="font-family:'Lucida Console', monospace">sudo apt-get install webmin</li>
            <li style="list-style: none;">These steps were pulled from the official Webmin steps for Debian install <a href="https://www.webmin.com/deb.html">here</a></li>
        </ol>
    </ol>
    <p style="background-color: rgb(255, 255, 163);">* The dns challenge must be specified since we are not using public facing web servers for this. This will require you add a dns record to the domain that you're looking to use.</p>
    <p style="background-color: rgb(255, 255, 163);">** It is important that you run the Openstack/Micorstack installation as the root user on the server. This will prevent some conflicts in the web interfaces of Openstack Horizon and Webmin.</p>
</article>
</html>